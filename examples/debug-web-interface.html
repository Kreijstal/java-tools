<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JVM Debug API Example</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background-color: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            border-radius: 5px;
        }
        
        .panel h3 {
            margin-top: 0;
            color: #569cd6;
        }
        
        .controls {
            grid-column: 1 / -1;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }
        
        button:hover {
            background-color: #1177bb;
        }
        
        button:disabled {
            background-color: #3e3e42;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 3px;
            border-left: 4px solid #007acc;
            background-color: #0f4a85;
        }
        
        .output {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 3px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .state-display {
            font-size: 12px;
        }
        
        .state-display .key {
            color: #9cdcfe;
        }
        
        .state-display .value {
            color: #ce9178;
        }
        
        .breakpoint-input {
            background-color: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 5px;
            border-radius: 3px;
            width: 60px;
            margin-right: 10px;
        }
        
        .error {
            color: #f44747;
            background-color: #5a1d1d;
            border-left-color: #f44747;
        }
        
        .success {
            color: #4ec9b0;
            background-color: #1e3a32;
            border-left-color: #4ec9b0;
        }
    </style>
</head>
<body>
    <h1>üîç JVM Debug API Example</h1>
    <p>This example demonstrates how to use the JVM debug API from JavaScript/Web applications.</p>
    
    <div class="panel controls">
        <h3>Debug Controls</h3>
        <div id="status" class="status">Ready - No program loaded</div>
        
        <div class="button-group">
            <button onclick="startDebugging()">Start Debugging (VerySimple.class)</button>
            <button onclick="stepInto()" id="stepIntoBtn" disabled>Step Into</button>
            <button onclick="stepOver()" id="stepOverBtn" disabled>Step Over</button>
            <button onclick="stepOut()" id="stepOutBtn" disabled>Step Out</button>
            <button onclick="stepInstruction()" id="stepInstructionBtn" disabled>Step Instruction</button>
            <button onclick="continue_()" id="continueBtn" disabled>Continue</button>
            <button onclick="finish()" id="finishBtn" disabled>Finish Method</button>
        </div>
        
        <div class="button-group">
            <input type="number" id="breakpointInput" class="breakpoint-input" placeholder="PC" min="0">
            <button onclick="setBreakpoint()">Set Breakpoint</button>
            <button onclick="clearBreakpoints()">Clear All Breakpoints</button>
            <button onclick="serializeState()">Serialize State</button>
            <button onclick="deserializeState()" id="deserializeBtn" disabled>Restore State</button>
        </div>
    </div>
    
    <div class="container">
        <div class="panel">
            <h3>Execution State</h3>
            <div id="executionState" class="state-display">
                <div><span class="key">Status:</span> <span class="value">Not started</span></div>
                <div><span class="key">PC:</span> <span class="value">-</span></div>
                <div><span class="key">Stack:</span> <span class="value">[]</span></div>
                <div><span class="key">Locals:</span> <span class="value">[]</span></div>
                <div><span class="key">Call Depth:</span> <span class="value">0</span></div>
                <div><span class="key">Method:</span> <span class="value">-</span></div>
                <div><span class="key">Breakpoints:</span> <span class="value">[]</span></div>
            </div>
        </div>
        
        <div class="panel">
            <h3>Output Console</h3>
            <div id="output" class="output"></div>
        </div>
    </div>
    
    <div class="panel">
        <h3>Usage Instructions</h3>
        <div style="font-size: 12px; line-height: 1.5;">
            <p><strong>Note:</strong> This is a frontend demonstration. In a real application, the JVM debug controller would run on the Node.js backend, and you'd communicate with it via HTTP/WebSocket APIs.</p>
            
            <p><strong>Debug Commands:</strong></p>
            <ul>
                <li><strong>Start Debugging:</strong> Loads VerySimple.class and begins debug session</li>
                <li><strong>Step Into:</strong> Execute next instruction, entering method calls</li>
                <li><strong>Step Over:</strong> Execute next instruction, skipping over method calls</li>
                <li><strong>Step Out:</strong> Continue until current method returns</li>
                <li><strong>Step Instruction:</strong> Execute exactly one bytecode instruction</li>
                <li><strong>Continue:</strong> Run until next breakpoint or completion</li>
                <li><strong>Finish Method:</strong> Run until current method completes</li>
            </ul>
            
            <p><strong>State Management:</strong></p>
            <ul>
                <li><strong>Serialize State:</strong> Capture complete JVM state for persistence</li>
                <li><strong>Restore State:</strong> Reload previously serialized state</li>
                <li><strong>Breakpoints:</strong> Set/clear breakpoints at specific program counter locations</li>
            </ul>
        </div>
    </div>

    <script>
        // Simulated debug controller for frontend demo
        // In a real application, this would be API calls to your Node.js backend
        
        let currentState = {
            status: 'stopped',
            pc: null,
            stack: [],
            locals: [],
            callDepth: 0,
            method: null,
            breakpoints: []
        };
        
        let serializedState = null;
        let stepCount = 0;
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        function updateState(newState) {
            currentState = { ...currentState, ...newState };
            
            const stateDisplay = document.getElementById('executionState');
            stateDisplay.innerHTML = `
                <div><span class="key">Status:</span> <span class="value">${currentState.status}</span></div>
                <div><span class="key">PC:</span> <span class="value">${currentState.pc ?? '-'}</span></div>
                <div><span class="key">Stack:</span> <span class="value">[${currentState.stack.join(', ')}]</span></div>
                <div><span class="key">Locals:</span> <span class="value">[${currentState.locals.join(', ')}]</span></div>
                <div><span class="key">Call Depth:</span> <span class="value">${currentState.callDepth}</span></div>
                <div><span class="key">Method:</span> <span class="value">${currentState.method || '-'}</span></div>
                <div><span class="key">Breakpoints:</span> <span class="value">[${currentState.breakpoints.join(', ')}]</span></div>
            `;
            
            updateButtons();
        }
        
        function updateButtons() {
            const isPaused = currentState.status === 'paused';
            const isRunning = currentState.status === 'running';
            
            document.getElementById('stepIntoBtn').disabled = !isPaused;
            document.getElementById('stepOverBtn').disabled = !isPaused;
            document.getElementById('stepOutBtn').disabled = !isPaused;
            document.getElementById('stepInstructionBtn').disabled = !isPaused;
            document.getElementById('continueBtn').disabled = !isPaused;
            document.getElementById('finishBtn').disabled = !isPaused;
            document.getElementById('deserializeBtn').disabled = !serializedState;
        }
        
        function startDebugging() {
            log('Starting debug session with VerySimple.class...', 'info');
            updateStatus('Starting debugger...', 'info');
            
            // Simulate API call to backend
            setTimeout(() => {
                updateState({
                    status: 'paused',
                    pc: 0,
                    stack: [],
                    locals: [null, null, null],
                    callDepth: 1,
                    method: 'main([Ljava/lang/String;)V',
                    breakpoints: []
                });
                
                updateStatus('Debugger started - Paused at beginning of main method', 'success');
                log('Debug session started successfully', 'success');
                log('JVM paused at PC=0 in main method', 'info');
            }, 500);
        }
        
        function stepInto() {
            executeStep('Step Into');
        }
        
        function stepOver() {
            executeStep('Step Over');
        }
        
        function stepOut() {
            executeStep('Step Out');
        }
        
        function stepInstruction() {
            executeStep('Step Instruction');
        }
        
        function finish() {
            executeStep('Finish Method');
        }
        
        function continue_() {
            log('Continuing execution...', 'info');
            updateStatus('Running...', 'info');
            
            setTimeout(() => {
                // Simulate hitting a breakpoint or completion
                if (currentState.breakpoints.length > 0 && Math.random() > 0.5) {
                    const bp = currentState.breakpoints[0];
                    updateState({
                        status: 'paused',
                        pc: bp
                    });
                    updateStatus(`Paused at breakpoint PC=${bp}`, 'success');
                    log(`Hit breakpoint at PC=${bp}`, 'success');
                } else {
                    updateState({
                        status: 'completed',
                        pc: null,
                        callDepth: 0
                    });
                    updateStatus('Program execution completed', 'success');
                    log('Program execution completed successfully', 'success');
                }
            }, 1000);
        }
        
        function executeStep(stepType) {
            log(`Executing ${stepType}...`, 'info');
            updateStatus(`Stepping...`, 'info');
            stepCount++;
            
            setTimeout(() => {
                if (stepCount >= 10) {
                    // Simulate completion
                    updateState({
                        status: 'completed',
                        pc: null,
                        callDepth: 0
                    });
                    updateStatus('Program execution completed', 'success');
                    log('Program execution completed', 'success');
                } else {
                    // Simulate step execution
                    const newPc = (currentState.pc || 0) + Math.floor(Math.random() * 3) + 1;
                    const newStack = stepCount % 3 === 0 ? 
                        [...currentState.stack, Math.floor(Math.random() * 100)] : 
                        currentState.stack;
                    
                    updateState({
                        status: 'paused',
                        pc: newPc,
                        stack: newStack
                    });
                    
                    updateStatus(`Paused after ${stepType.toLowerCase()} at PC=${newPc}`, 'success');
                    log(`${stepType} completed - PC=${newPc}, Stack=[${newStack.join(', ')}]`, 'info');
                }
            }, 300);
        }
        
        function setBreakpoint() {
            const input = document.getElementById('breakpointInput');
            const pc = parseInt(input.value);
            
            if (isNaN(pc) || pc < 0) {
                log('Invalid breakpoint location', 'error');
                return;
            }
            
            if (currentState.breakpoints.includes(pc)) {
                log(`Breakpoint already exists at PC=${pc}`, 'error');
                return;
            }
            
            const newBreakpoints = [...currentState.breakpoints, pc].sort((a, b) => a - b);
            updateState({ breakpoints: newBreakpoints });
            
            log(`Breakpoint set at PC=${pc}`, 'success');
            input.value = '';
        }
        
        function clearBreakpoints() {
            updateState({ breakpoints: [] });
            log('All breakpoints cleared', 'success');
        }
        
        function serializeState() {
            serializedState = {
                jvmState: {
                    frames: [{
                        methodRef: { className: 'VerySimple', methodName: 'main', methodDescriptor: '([Ljava/lang/String;)V' },
                        stack: currentState.stack,
                        locals: currentState.locals,
                        pc: currentState.pc
                    }],
                    classes: { 'VerySimple': {} },
                    debugMode: true,
                    breakpoints: currentState.breakpoints,
                    stepMode: null
                },
                executionState: currentState.status
            };
            
            const stateSize = JSON.stringify(serializedState).length;
            log(`State serialized successfully (${stateSize} bytes)`, 'success');
            updateButtons();
        }
        
        function deserializeState() {
            if (!serializedState) {
                log('No serialized state available', 'error');
                return;
            }
            
            updateState({
                status: serializedState.executionState,
                pc: serializedState.jvmState.frames[0]?.pc || 0,
                stack: serializedState.jvmState.frames[0]?.stack || [],
                locals: serializedState.jvmState.frames[0]?.locals || [],
                breakpoints: serializedState.jvmState.breakpoints || [],
                callDepth: serializedState.jvmState.frames.length || 0,
                method: 'main([Ljava/lang/String;)V'
            });
            
            updateStatus('State restored from serialized data', 'success');
            log('JVM state restored successfully', 'success');
        }
        
        // Initialize
        updateState(currentState);
        log('JVM Debug API Example loaded', 'info');
        log('Click "Start Debugging" to begin', 'info');
    </script>
</body>
</html>